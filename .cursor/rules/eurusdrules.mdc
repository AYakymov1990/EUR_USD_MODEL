# === Проект: Trader CRM для EUR/USD ===

- rule: Цель проекта  
  details: >
    Демонстрационная CRM для трейдера: показывает сигнал модели (с объяснением),
    отправляет уведомление, оператор подтверждает Long/Short, затем заявка уходит в OANDA v20.
    По умолчанию запускается в demo mode (реплей тестового среза, без реальных ордеров).
    Архитектура модели и обучения заморожена; меняем только обвязку/CRM.

- rule: Архитектура  
  details: >
    Слои:
      - Model layer (src.features, src.model, src.backtest, notebooks 02/03) — не менять, только использовать.
      - CRM layer (Streamlit UI + модули src.crm.*) — сбор сигналов, объяснение, логирование, исполнение.
      - Интеграции: OANDA v20 REST (practice по умолчанию), SQLite-аудит (signals/actions/orders/fills).
    Данные/артефакты: data/eurusd_features.parquet, data/artifacts/selected_config.json (+ сохраненные модели/скейлеры).

- rule: Безопасность и конфиг  
  details: >
    Никогда не коммитим ключи. Используем .env / переменные окружения / config/*.json (без секретов).
    По умолчанию practice environment; live включается явно.
    Любой сетевой вызов оборачиваем try/except и логируем ошибку без утечки ключей.

- rule: Политика сигналов  
  details: >
    Сигнал = y_hat, режимы и порог из selected_config.json. Торгуем только после явного подтверждения оператора.
    В demo mode исполнение отключено, но сигнал/действия пишем в SQLite для аудита и UI.
    Объяснение сигнала (короткое, RU) выводится в UI и уведомления.

- rule: Логирование и аудит  
  details: >
    Логируем все сигналы, нажатия LONG/SHORT, отправленные ордера, ответы OANDA, ошибки.
    Аудит храним в SQLite (tables: signals, actions, orders/fills, metrics_snapshots).
    В UI показываем метрики: equity, winrate, profit_factor, max_drawdown, hit_rate.

- rule: Демонстрация  
  details: >
    Для демо до 15 января: приложение должно работать end-to-end в demo mode без сети.
    В live режиме (опционально) нужно иметь возможность получить аккаунт/баланс и выставить market order после подтверждения.
    UI (Streamlit) обязателен: последние сигналы + объяснение, кнопки Long/Short, состояние счёта, мини-метрики.

- rule: Стиль кода  
  details: >
    Python 3.10+, PEP8, понятные имена (snake_case). Docstrings на ключевых функциях.
    Импорты: stdlib -> third-party -> local. Код на английских идентификаторах, пояснения/доки на русском.
    Конфигурация через env/dataclass-конфиг, без глобальных констант с секретами.

- rule: Файловая структура  
  details: >
    notebooks/01_*, 02_*, 03_* — эксперименты и обучение.
    src/ — прод-код, теперь включает src.crm.* (config, data_feed, inference, explain, signals, oanda_executor, storage, metrics_live, scheduler).
    docs/ — архитектура и планы (см. docs/00_overview.md и далее).

- rule: Готовность демо  
  details: >
    Done, если: (1) выбранный конфиг/модель загружаются, (2) сигналы и объяснения отображаются,
    (3) demo mode генерирует сигналы и пишет их в SQLite, (4) UI показывает счёт/метрики,
    (5) live mode может отправить заявку после подтверждения (при наличии ключей).
